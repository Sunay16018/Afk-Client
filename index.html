<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MC Bot Manager Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="app-container">
        <nav class="top-nav">
            <button onclick="showTab('bots')"><i class="fas fa-plug"></i> Botlar</button>
            <button onclick="showTab('terminal')"><i class="fas fa-terminal"></i> Konsol</button>
            <button onclick="showTab('radar')"><i class="fas fa-crosshairs"></i> Radar</button>
            <button onclick="toggleInv()" class="bag-btn"><i class="fas fa-shopping-bag"></i></button>
        </nav>

        <div id="inv-panel" class="overlay">
            <div class="inv-modal">
                <div class="inv-header">Envanter <i class="fas fa-times" onclick="toggleInv()"></i></div>
                <div class="grid" id="inv-grid"></div>
            </div>
        </div>

        <div id="tab-bots" class="tab active">
            <div class="login-form">
                <input type="text" id="host" placeholder="Sunucu IP">
                <input type="text" id="user" placeholder="Bot Nick">
                <select id="ver"><option value="1.8.8">1.8.8</option><option value="1.20.1" selected>1.20.1</option></select>
                <button onclick="connectBot()">SİSTEME BAĞLA</button>
            </div>
            <div id="bot-list" class="cards-container"></div>
        </div>

        <div id="tab-terminal" class="tab">
            <div class="current-header">
                <span id="cur-name">Seçili Değil</span>
                <button onclick="quitBot()" class="quit-btn">Bağlantıyı Kes</button>
            </div>
            <div class="stats-row">
                <span><i class="fas fa-heart"></i> <span id="h">0</span></span>
                <span><i class="fas fa-hamburger"></i> <span id="f">0</span></span>
                <span><i class="fas fa-map-marker-alt"></i> <span id="p">0,0</span></span>
            </div>
            <div id="logbox" class="terminal"></div>
            <div class="input-row">
                <input type="text" id="msg" placeholder="Mesaj veya komut..." autocomplete="off">
                <button onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <div id="tab-radar" class="tab">
            <div class="radar-map"><div id="radar-ui" class="radar-circle"><div class="center"></div></div></div>
        </div>
    </div>

    <script>
        let selectedBot = null;
        let autoScroll = true;

        // Slotları oluştur
        const grid = document.getElementById('inv-grid');
        for(let i=9; i<=44; i++){
            let s = document.createElement('div');
            s.className = 'slot'; s.id = 'slot-'+i;
            grid.appendChild(s);
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-'+tabId).classList.add('active');
        }

        function toggleInv() {
            document.getElementById('inv-panel').classList.toggle('open');
        }

        async function connectBot() {
            const h = document.getElementById('host').value;
            const u = document.getElementById('user').value;
            const v = document.getElementById('ver').value;
            await fetch(`/start?host=${h}&user=${u}&ver=${v}`);
        }

        async function quitBot() {
            if(!selectedBot) return;
            await fetch(`/quit?user=${selectedBot}`);
            selectedBot = null;
        }

        async function sendMsg() {
            const input = document.getElementById('msg');
            if(!selectedBot || !input.value) return;
            await fetch(`/send?user=${selectedBot}&msg=${encodeURIComponent(input.value)}`);
            input.value = '';
        }

        document.getElementById('msg').onkeypress = (e) => e.key === 'Enter' && sendMsg();

        setInterval(async () => {
            try {
                const res = await fetch('/getall');
                const data = await res.json();

                const list = document.getElementById('bot-list');
                list.innerHTML = data.activeBots.map(n => `
                    <div class="bot-card ${selectedBot===n?'selected':''}" onclick="selectedBot='${n}'; document.getElementById('cur-name').innerText='${n}'">
                        <i class="fas fa-user-circle"></i> ${n}
                    </div>
                `).join('');

                if(selectedBot && data.status[selectedBot]) {
                    const s = data.status[selectedBot];
                    document.getElementById('h').innerText = s.health;
                    document.getElementById('f').innerText = s.food;
                    document.getElementById('p').innerText = `${s.pos.x}, ${s.pos.z}`;
                    
                    const lb = document.getElementById('logbox');
                    lb.innerHTML = (data.logs[selectedBot] || []).join('<br>');
                    if(autoScroll) lb.scrollTop = lb.scrollHeight;

                    // Radar
                    const rUI = document.getElementById('radar-ui');
                    document.querySelectorAll('.player-dot').forEach(d => d.remove());
                    s.players.forEach(p => {
                        let dot = document.createElement('div');
                        dot.className = 'player-dot';
                        dot.style.left = (90 + p.x) + 'px'; dot.style.top = (90 + p.z) + 'px';
                        rUI.appendChild(dot);
                    });

                    // Envanter
                    if(document.getElementById('inv-panel').classList.contains('open')) {
                        document.querySelectorAll('.slot').forEach(x => x.innerHTML = '');
                        (data.invs[selectedBot] || []).forEach(item => {
                            const sd = document.getElementById('slot-'+item.slot);
                            if(sd) sd.innerHTML = `<img src="https://raw.githubusercontent.com/PrismarineJS/minecraft-assets/master/data/pc/1.20.1/items/${item.name}.png"><span>${item.count>1?item.count:''}</span>`;
                        });
                    }
                }
            } catch(e) {}
        }, 1000);

        const lb = document.getElementById('logbox');
        lb.onscroll = () => autoScroll = (lb.scrollHeight - lb.scrollTop - lb.clientHeight < 50);
    </script>
</body>
</html>

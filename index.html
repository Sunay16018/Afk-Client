<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BotMaster v26 - Fix</title>
    <style>
        :root { --bg: #0c0c0e; --p: #16161a; --b: #2d2d33; --a: #6366f1; --t: #f4f4f5; --r: #f43f5e; --g: #10b981; }
        * { box-sizing: border-box; outline: none; }
        body { background: var(--bg); color: var(--t); margin: 0; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
        
        nav { display: flex; background: var(--p); height: 50px; width: 100%; max-width: 500px; border-bottom: 2px solid var(--b); gap: 4px; padding: 5px; }
        nav button { flex: 1; background: #232329; border: none; color: #888; border-radius: 6px; font-weight: bold; font-size: 11px; cursor: pointer; }
        nav button.active { background: var(--a); color: white; }

        .tab { display: none; padding: 10px; width: 100%; max-width: 500px; flex: 1; overflow-y: auto; }
        .tab.show { display: flex; flex-direction: column; }

        .con-wrapper { width: 100%; border: 2px solid var(--b); border-radius: 12px; overflow: hidden; background: #000; }
        #logs { height: 300px; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 11px; }

        /* ENVANTER TASARIMI */
        .inv-gui { background: #8b8b8b; padding: 10px; border: 4px solid #373737; display: grid; grid-template-columns: repeat(9, 1fr); gap: 2px; width: fit-content; margin: 0 auto; box-shadow: inset 2px 2px #fff, inset -2px -2px #555; }
        .slot { width: 36px; height: 36px; background: #8b8b8b; border: 2px solid #373737; display: flex; align-items: center; justify-content: center; position: relative; cursor: pointer; box-shadow: inset -1px -1px #fff, inset 1px 1px #555; }
        .slot:hover { background: rgba(255,255,255,0.2); }
        .slot img { width: 30px; image-rendering: pixelated; }
        .count { position: absolute; bottom: 2px; right: 2px; color: white; font-size: 10px; text-shadow: 1px 1px #000; font-weight: bold; }

        /* 4 SE√áENEKLƒ∞ MEN√ú */
        #ctx { display: none; position: fixed; background: #1c1c1f; border: 1px solid var(--b); z-index: 9999; width: 140px; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        #ctx button { display: block; width: 100%; padding: 12px; background: none; border: none; color: white; border-bottom: 1px solid #333; text-align: left; font-size: 12px; cursor: pointer; }
        #ctx button:hover { background: var(--a); }
        .nbt-info { padding: 8px; font-size: 10px; color: #aaa; background: #111; border-top: 1px solid #333; }

        .input-box { width: 100%; padding: 12px; background: #000; border: 1px solid var(--b); color: #fff !important; border-radius: 8px; margin-bottom: 10px; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; }
    </style>
</head>
<body onclick="hideCtx()">

    <nav>
        <button onclick="tab('bots', this)" class="active">BOTLAR</button>
        <button onclick="tab('console', this)">KONSOL</button>
        <button onclick="tab('status', this)">ENVANTER</button>
        <button onclick="tab('settings', this)">AYARLAR</button>
    </nav>

    <div id="ctx">
        <div id="nbt-box" class="nbt-info">E≈üya Bilgisi...</div>
        <button onclick="invAct('equip')">‚öîÔ∏è Elinde Tut</button>
        <button onclick="invAct('use')">üçé Kullan / Ye</button>
        <button onclick="invAct('toss')">üóëÔ∏è 1 Tane At</button>
        <button onclick="invAct('drop')">üì¶ Hepsini At</button>
    </div>

    <div id="p-bots" class="tab show">
        <div style="background:var(--p); padding:15px; border-radius:12px; border:1px solid var(--b);">
            <input id="ip" class="input-box" placeholder="ip:port">
            <input id="usr" class="input-box" placeholder="Bot ƒ∞smi">
            <button onclick="connect()" class="btn" style="background:var(--g)">BAƒûLAN</button>
        </div>
        <div id="blist" style="margin-top:10px;"></div>
    </div>

    <div id="p-console" class="tab">
        <div class="con-wrapper">
            <div id="logs"></div>
            <div style="display:flex; padding:8px; gap:5px; background:#111; border-top:1px solid #333;">
                <input id="msg" class="input-box" style="margin:0" placeholder="Mesaj..." onkeydown="if(event.key==='Enter') send()">
                <button onclick="send()" class="btn" style="width:auto; padding:0 20px; background:var(--a)">></button>
            </div>
        </div>
    </div>

    <div id="p-status" class="tab">
        <div style="text-align:center; margin-bottom:10px;">‚ù§Ô∏è <span id="hp">0</span> | üçñ <span id="fd">0</span></div>
        <div class="inv-gui" id="inv"></div>
    </div>

    <div id="p-settings" class="tab">
        <div style="background:var(--p); padding:15px; border-radius:12px; border:1px solid var(--b);">
            <b>Otomatik Mesaj</b>
            <input id="mtxt" class="input-box" placeholder="Metin...">
            <input id="msec" type="number" class="input-box" value="10" placeholder="Saniye">
            <button id="mbtn" class="btn" style="background:var(--a)" onclick="toggleSpam()">SPAM BA≈ûLAT</button>
        </div>
    </div>

    <script>
        let sel = null; let botLogs = {}; let currentSlot = null;
        const botSpamState = {}; 

        function tab(t, b) {
            document.querySelectorAll('.tab').forEach(x=>x.classList.remove('show'));
            document.querySelectorAll('nav button').forEach(x=>x.classList.remove('active'));
            document.getElementById('p-'+t).classList.add('show');
            b.classList.add('active');
        }

        async function connect() {
            const h=document.getElementById('ip').value, u=document.getElementById('usr').value;
            if(!h || !u) return;
            await fetch(`/start?host=${h}&user=${u}`);
            sel = u; botLogs[u] = []; botSpamState[u] = false;
            tab('console', document.querySelectorAll('nav button')[1]);
        }

        function switchBot(u) {
            sel = u;
            document.getElementById('logs').innerHTML = (botLogs[u] || []).join('');
            updateSpamButtonUI();
        }

        function toggleSpam() {
            if(!sel) return;
            botSpamState[sel] = !botSpamState[sel];
            const msg = document.getElementById('mtxt').value;
            const sec = document.getElementById('msec').value;
            fetch(`/update?user=${sel}&type=auto_msg&status=${botSpamState[sel]?'on':'off'}&val=${msg}|${sec}`);
            updateSpamButtonUI();
        }

        function updateSpamButtonUI() {
            const btn = document.getElementById('mbtn');
            if(botSpamState[sel]) { btn.innerText = "SPAM DURDUR"; btn.style.background = "var(--r)"; }
            else { btn.innerText = "SPAM BA≈ûLAT"; btn.style.background = "var(--a)"; }
        }

        function openItemMenu(e, slot, name, nbt) {
            e.preventDefault(); e.stopPropagation();
            currentSlot = slot;
            const menu = document.getElementById('ctx');
            document.getElementById('nbt-box').innerText = name + (nbt ? "\n" + JSON.stringify(nbt).substring(0,50) + "..." : "");
            menu.style.display = 'block';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
        }

        function hideCtx() { document.getElementById('ctx').style.display = 'none'; }

        async function invAct(act) {
            if(sel && currentSlot !== null) fetch(`/update?user=${sel}&type=inv&val=${currentSlot}&status=${act}`);
            hideCtx();
        }

        async function send() {
            const m = document.getElementById('msg');
            if(!sel || !m.value) return;
            fetch(`/send?user=${sel}&msg=${encodeURIComponent(m.value)}`);
            m.value = '';
        }

        setInterval(async () => {
            const r = await fetch(`/data?user=${sel||''}`);
            const d = await r.json();

            document.getElementById('blist').innerHTML = d.active.map(b => `
                <div style="display:flex; justify-content:space-between; padding:10px; background:#111; margin-bottom:5px; border-radius:8px; border:1px solid ${sel===b?'var(--a)':'#222'}" onclick="switchBot('${b}')">
                    <span>${b}</span>
                    <button onclick="fetch('/stop?user=${b}')" style="background:var(--r); border:none; color:white; border-radius:4px; padding:2px 8px; font-size:10px;">KES</button>
                </div>
            `).join('');

            if(sel && d.botData[sel]) {
                const b = d.botData[sel];
                if(b.logs.length > 0) {
                    if(!botLogs[sel]) botLogs[sel] = [];
                    botLogs[sel].push(...b.logs);
                    const lb = document.getElementById('logs');
                    b.logs.forEach(m => { lb.innerHTML += m; });
                    lb.scrollTop = lb.scrollHeight;
                }
                document.getElementById('hp').innerText = Math.round(b.health);
                document.getElementById('fd').innerText = Math.round(b.food);
                
                const iG = document.getElementById('inv'); iG.innerHTML = '';
                for(let i=0; i<45; i++) {
                    const it = b.inventory.find(x => x.slot === i);
                    // G√∂r√ºn√ºm√º bozuk olan e≈üyalar i√ßin fallback resmi eklendi
                    const imgUrl = it ? `https://raw.githubusercontent.com/PrismarineJS/minecraft-assets/master/data/1.16.1/items/${it.name}.png` : '';
                    iG.innerHTML += `<div class="slot" onclick="openItemMenu(event, ${i}, '${it?it.displayName:''}', ${it?JSON.stringify(it.nbt):null})">
                        ${it ? `<img src="${imgUrl}" onerror="this.src='https://minecraft.wiki/images/Barrier_JE2_BE2.png'"><span class="count">${it.count > 1 ? it.count : ''}</span>` : ''}
                    </div>`;
                }
            }
        }, 1000);
    </script>
</body>
</html>

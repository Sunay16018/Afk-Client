<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BotMaster v24</title>
    <style>
        :root { --bg: #0c0c0e; --p: #16161a; --b: #2d2d33; --a: #6366f1; --t: #f4f4f5; --r: #f43f5e; --g: #10b981; }
        * { box-sizing: border-box; outline: none; }
        body { background: var(--bg); color: var(--t); margin: 0; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; height: 100vh; }
        
        nav { display: flex; background: var(--p); height: 45px; width: 100%; max-width: 450px; border-bottom: 2px solid var(--b); gap: 4px; padding: 4px; }
        nav button { flex: 1; background: #232329; border: none; color: #888; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 10px; }
        nav button.active { background: var(--a); color: white; }

        .tab { display: none; padding: 10px; width: 100%; max-width: 450px; flex: 1; overflow-y: auto; }
        .tab.show { display: flex; flex-direction: column; }

        .bot-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #111; border: 1px solid var(--b); border-radius: 8px; margin-bottom: 5px; cursor: pointer; }
        .bot-row.active { border-color: var(--a); background: #1a1a20; }
        
        .con-box { width: 100%; border: 2px solid var(--b); border-radius: 10px; overflow: hidden; background: #000; display: flex; flex-direction: column; }
        #logs { height: 280px; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 11px; line-height: 1.4; }
        .log-row { border-bottom: 1px solid #111; padding: 2px 0; white-space: pre-wrap; }

        .chat-bar { display: flex; padding: 8px; gap: 5px; background: #1a1a1e; border-top: 1px solid var(--b); }
        .chat-bar input { flex: 1; background: #000; border: 1px solid var(--b); color: #fff; padding: 8px; border-radius: 5px; }

        .inv-gui { background: #8b8b8b; padding: 8px; border: 3px solid #373737; display: grid; grid-template-columns: repeat(9, 1fr); gap: 2px; margin: 0 auto; }
        .slot { width: 32px; height: 32px; background: #8b8b8b; border: 2px solid #373737; display: flex; align-items: center; justify-content: center; }
        .slot img { width: 26px; image-rendering: pixelated; }

        .btn { background: var(--a); color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 5px; }
        .btn-red { background: var(--r); padding: 5px 10px; font-size: 10px; }
        .input-box { width: 100%; padding: 10px; background: #000; border: 1px solid var(--b); color: #fff !important; border-radius: 5px; margin-bottom: 8px; }
    </style>
</head>
<body>

    <nav>
        <button onclick="tab('bots', this)" class="active">BOTLAR</button>
        <button onclick="tab('console', this)">SOHBET</button>
        <button onclick="tab('status', this)">DURUM</button>
    </nav>

    <div id="p-bots" class="tab show">
        <div style="background:var(--p); padding:12px; border-radius:10px; border:1px solid var(--b); margin-bottom:10px;">
            <input id="ip" class="input-box" placeholder="server:port">
            <input id="usr" class="input-box" placeholder="Kullanƒ±cƒ± Adƒ±">
            <button onclick="connect()" class="btn" style="background:var(--g); width:100%">BAƒûLAN</button>
        </div>
        <div id="blist"></div>
    </div>

    <div id="p-console" class="tab">
        <div id="cur-bot-name" style="font-size:12px; margin-bottom:5px; color:var(--a); font-weight:bold;">Se√ßili Bot: Yok</div>
        <div class="con-box">
            <div id="logs"></div>
            <div class="chat-bar">
                <input id="msg" placeholder="Mesaj..." onkeydown="if(event.key==='Enter') send()">
                <button onclick="send()" class="btn" style="margin:0; padding:0 15px;">></button>
            </div>
        </div>
    </div>

    <div id="p-status" class="tab">
        <div style="text-align:center; margin-bottom:10px;">‚ù§Ô∏è <span id="hp">0</span> | üçñ <span id="fd">0</span></div>
        <div class="inv-gui" id="inv"></div>
    </div>

    <script>
        let sel = null;
        let botLogs = {}; // ANAHTAR NOKTA: { "Ahmet": ["mesaj1", "mesaj2"], "Mehmet": [] }

        function tab(t, b) {
            document.querySelectorAll('.tab').forEach(x=>x.classList.remove('show'));
            document.querySelectorAll('nav button').forEach(x=>x.classList.remove('active'));
            document.getElementById('p-'+t).classList.add('show');
            b.classList.add('active');
        }

        async function connect() {
            const h = document.getElementById('ip').value, u = document.getElementById('usr').value;
            if(!h || !u) return;
            await fetch(`/start?host=${h}&user=${u}`);
            switchBot(u);
            tab('console', document.querySelectorAll('nav button')[1]);
        }

        function switchBot(u) {
            sel = u;
            if(!botLogs[u]) botLogs[u] = []; // Eƒüer bu botun ge√ßmi≈üi yoksa olu≈ütur
            document.getElementById('cur-bot-name').innerText = "Se√ßili Bot: " + u;
            // Ekrandaki eski mesajlarƒ± temizle ve se√ßilen botun ge√ßmi≈üini y√ºkle
            document.getElementById('logs').innerHTML = botLogs[u].join('');
            document.getElementById('logs').scrollTop = document.getElementById('logs').scrollHeight;
        }

        async function disconnect(u, e) {
            e.stopPropagation();
            await fetch(`/stop?user=${u}`);
            delete botLogs[u];
            if(sel === u) { sel = null; document.getElementById('logs').innerHTML = ''; }
        }

        async function send() {
            const m = document.getElementById('msg');
            if(!sel || !m.value) return;
            fetch(`/send?user=${sel}&msg=${encodeURIComponent(m.value)}`);
            m.value = '';
        }

        setInterval(async () => {
            const r = await fetch(`/data?user=${sel||''}`);
            const d = await r.json();

            // Bot Listesini G√ºncelle
            document.getElementById('blist').innerHTML = d.active.map(b => `
                <div class="bot-row ${sel===b?'active':''}" onclick="switchBot('${b}')">
                    <span>${b}</span>
                    <button class="btn-red" onclick="disconnect('${b}', event)">KES</button>
                </div>
            `).join('');

            // Sadece se√ßili botun verilerini i≈üle
            if(sel && d.botData[sel]) {
                const b = d.botData[sel];
                
                // Gelen yeni mesajlarƒ± sadece o botun hafƒ±zasƒ±na ekle
                if(b.logs.length > 0) {
                    botLogs[sel].push(...b.logs);
                    if(botLogs[sel].length > 150) botLogs[sel].shift();
                    
                    // Eƒüer ≈üu an o botu izliyorsak ekrana yansƒ±t
                    const lb = document.getElementById('logs');
                    b.logs.forEach(msg => {
                        const div = document.createElement('div');
                        div.className = 'log-row';
                        div.innerHTML = msg;
                        lb.appendChild(div);
                    });
                    lb.scrollTop = lb.scrollHeight;
                }

                document.getElementById('hp').innerText = Math.round(b.health) || 0;
                document.getElementById('fd').innerText = Math.round(b.food) || 0;
                
                const iG = document.getElementById('inv'); iG.innerHTML = '';
                for(let i=9; i<45; i++) {
                    const it = b.inventory.find(x=>x.slot===i);
                    iG.innerHTML += `<div class="slot">${it?`<img src="https://raw.githubusercontent.com/PrismarineJS/minecraft-assets/master/data/1.16.1/items/${it.name}.png">`:''}</div>`;
                }
            }
        }, 1000);
    </script>
</body>
</html>

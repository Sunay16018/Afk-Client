<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Master Panel v14</title>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; margin:0; padding:0; font-size:13px; }
        body { background: #0d1117; color: #c9d1d9; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        nav { display: flex; background: #161b22; height: 45px; border-bottom: 1px solid #30363d; flex-shrink: 0; }
        nav button { flex: 1; border: none; background: none; color: #8b949e; cursor: pointer; font-weight: bold; }
        nav button.active { color: #2ecc71; border-bottom: 3px solid #2ecc71; }
        .tab { display: none; flex: 1; flex-direction: column; padding: 12px; }
        .active-tab { display: flex; }
        #logbox { height: 250px; background: #000; border: 2px solid #2ecc71; border-radius: 8px; padding: 10px; overflow-y: auto; color: #2ecc71; font-family: monospace; margin-bottom: 10px; }
        .card { background: #161b22; padding: 12px; border-radius: 8px; border: 1px solid #30363d; }
        input { background: #010409; border: 1px solid #30363d; color: #fff; padding: 10px; border-radius: 5px; }
        .btn { border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; }
        .btn-blue { background: #1f6feb; }
    </style>
</head>
<body>

    <nav>
        <button onclick="tab('bots')" id="btn-bots">BOTLARIM</button>
        <button onclick="tab('term')" id="btn-term" class="active">KONSOL</button>
    </nav>

    <div id="tab-bots" class="tab">
        <div class="card">
            <input id="h" placeholder="Sunucu IP:Port" style="width:100%; margin-bottom:5px;">
            <input id="u" placeholder="Bot Nick" style="width:100%; margin-bottom:5px;">
            <select id="v" style="width:100%; margin-bottom:5px; background:#010409; color:#fff; padding:8px;">
                <option value="1.8.8">1.8.8</option>
                <option value="1.12.2">1.12.2</option>
                <option value="1.16.5">1.16.5</option>
                <option value="1.20.1">1.20.1</option>
            </select>
            <button class="btn btn-blue" style="width:100%; background:#238636" onclick="add()">BAĞLAN</button>
        </div>
        <div id="list" style="margin-top:10px;"></div>
    </div>

    <div id="tab-term" class="tab active-tab">
        <div style="margin-bottom:5px;">Seçili: <b id="selName" style="color:#2ecc71">-</b></div>
        <div id="logbox"></div>
        <div class="card">
            <div style="display:flex; gap:5px;">
                <input id="m" placeholder="Mesajı yazın..." style="flex:1;">
                <button onclick="doSend()" class="btn btn-blue">GÖNDER</button>
            </div>
        </div>
    </div>

    <script>
        const mySID = localStorage.getItem('mySID') || 'u' + Math.random().toString(36).substr(2,4);
        localStorage.setItem('mySID', mySID);
        let sel = "";

        function tab(t) {
            document.querySelectorAll('.tab').forEach(x => x.classList.remove('active-tab'));
            document.querySelectorAll('nav button').forEach(x => x.classList.remove('active'));
            document.getElementById('tab-'+t).classList.add('active-tab');
            document.getElementById('btn-'+t).classList.add('active');
        }

        async function add() {
            const h = document.getElementById('h').value, u = document.getElementById('u').value, v = document.getElementById('v').value;
            await fetch(`/start?sid=${mySID}&host=${h}&user=${u}&ver=${v}`);
            sel = u; document.getElementById('selName').innerText = u;
            tab('term');
        }

        async function doSend() {
            const input = document.getElementById('m');
            const val = input.value.trim();
            if (!sel || !val) return;

            // URL üzerinden güvenli gönderim
            const r = await fetch(`/send?sid=${mySID}&user=${encodeURIComponent(sel)}&msg=${encodeURIComponent(val)}`);
            const res = await r.text();
            
            if(res === "ok") {
                input.value = "";
                input.focus();
            } else {
                alert("Mesaj gönderilemedi. Bot oyunda olmayabilir.");
            }
        }

        // Enter ile gönderme
        document.getElementById('m').onkeydown = (e) => { if(e.key === 'Enter') doSend(); };

        setInterval(async () => {
            try {
                const r = await fetch(`/data?sid=${mySID}`);
                const d = await r.json();
                
                document.getElementById('list').innerHTML = d.active.map(n => `
                    <div style="padding:10px; background:#21262d; border:1px solid ${sel==n?'#2ecc71':'#30363d'}; margin-top:5px; border-radius:5px; cursor:pointer;" onclick="sel='${n}'; document.getElementById('selName').innerText='${n}';">
                        ${n} ${sel==n?'<b>(SEÇİLİ)</b>':''}
                    </div>
                `).join('');

                if(sel && d.logs[sel]) {
                    const lb = document.getElementById('logbox');
                    lb.innerHTML = d.logs[sel].join('<br>');
                    lb.scrollTop = lb.scrollHeight;
                }
            } catch(e) {}
        }, 1000);
    </script>
</body>
</html>
